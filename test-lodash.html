<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="lodash.js"></script>
        <script src="bufferio.js"></script>
        <title></title>
    </head>
    <body>
        <div id="result"></div>
        <script defer="true">
            function callCFunction(name) {
                return function(objectToSerialize, args) {
                    const stack = Runtime.stackSave() // Returns STACKTOP

                    // Serialize on HEAP32 from offset 'stack >> 2', same as serializing on HEAPU8 from offset 'stack'
                    const length = encode(objectToSerialize, HEAP32, stack >> 2)

                    // Allocates 'length << 2' bytes of memory, because we need 4 bytes per unit since we use HEAP32
                    const offset = Runtime.stackAlloc(length << 2) // Returns old STACKTOP and increases STACKTOP

                    const ret = Module.asm['_'+name](offset, ...args) // The value returned by our function (a reference on HEAP)

                    Runtime.stackRestore(stack) // Reset STACKTOP to stack
                    return ret
                }
            }
            let objectToSerialize = [{a: 1}, true, 'éêДϿꓷ𠜎', ~0, false, 34, {a:{b:2,c:4}}]

            const resultHead = callCFunction('head')(objectToSerialize, [])
            console.log('The result of head is', resultHead !== -1 ? decode(HEAP32, resultHead) : 'Invalid input array')

            const resultIdentity = callCFunction('identity')(objectToSerialize, [])
            console.log('The result of identity is', resultIdentity !== -1 ? decode(HEAP32, resultIdentity >> 2) : 'Invalid input array')

            const resultGetAtIndex = callCFunction('getAtIndex')(objectToSerialize, [2])
            console.log('The result of getAtIndex is', resultGetAtIndex !== -1 ? decode(HEAP32, resultGetAtIndex) : 'Invalid input array')
        </script>
    </body>
</html>
