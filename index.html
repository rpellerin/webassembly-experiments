<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <style>
            table { border-collapse: collapse }
            th, td {
                border: 1px solid black;
                padding: 5px;
            }
            .fast {
                background-color: #CFC
            }
            .slower {
                background-color: #FFB
            }
            .slowest {
                background-color: #F99
            }
        </style>
    </head>
    <body>
        <h1>asm.js / WebAssembly examples</h1>
        <form action="" method="post" onsubmit="return false;">
            Find prime numbers between 2 and <input min="2" type="number" id="upper-limit-prime" value="100000"/><button onClick="run(); return false;">Run</button>
        </form>
        <br />
        <table id="results-table">
            <thead>
                <tr>
                    <th>Upper limit</th>
                    <th>Plain Javascript</th>
                    <th>asm.js</th>
                    <th>WebAssembly</th>
                </tr>
            </thead>
        </table>
        <script type="text/javascript">


            function run() {
                if (!window.Worker) {
                    alert('Your browser does not support Web Workers.')
                    return
                }

                function attachTdTo(tr, val = 'Running...') {
                    let td = document.createElement('td')
                    td.innerHTML = val
                    tr.appendChild(td)
                    return td
                }

                const upperLimitPrime = document.getElementById("upper-limit-prime").value;
                const tr = document.createElement('tr')
                const tds = {}
                tds.upperLimitPrime = attachTdTo(tr, upperLimitPrime)
                tds.plain_nbOfPrimesFound = attachTdTo(tr)
                tds.asm_nbOfPrimesFound = attachTdTo(tr)
                tds.wasm_nbOfPrimesFound = attachTdTo(tr)
                document.getElementById("results-table").appendChild(tr)

                const tdsArray = []
                const resultHandler = data => {
                    tds[data.name].innerHTML = `${data.result} <br><strong>${data.timeTaken}</strong> ms`
                    tds[data.name].timeTaken = data.timeTaken

                    tdsArray.push(tds[data.name])
                    tdsArray.sort((td1, td2) => td1.timeTaken - td2.timeTaken )
                            .forEach( (td, index) => {
                                switch(index) {
                                    case 0: return td.className = 'fast'
                                    case 1: return td.className = 'slower'
                                    case 2: return td.className = 'slowest'
                                }
                            })
                }
                const readyHandler = data => worker.postMessage({actionType: 'run'})

                var worker = new Worker('worker.js')

                worker.onmessage = ({ data }) => {
                    switch(data.actionType) {
                        case 'ready' :
                            return readyHandler(data)
                        case 'result':
                            return resultHandler(data)
                    }
                }
                worker.postMessage({actionType:'init', upperLimitPrime})

            }
        </script>
    </body>
</html>
